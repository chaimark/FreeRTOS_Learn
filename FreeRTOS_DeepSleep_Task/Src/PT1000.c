#include "Define.h"
#include "PT1000.h"
#include "AT24CXXDataLoader.h"
#include "GP21.h"

const unsigned int MeterTemperature_Table[][10] = {
    {10000, 10004, 10008, 10012, 10016, 10020, 10023, 10027, 10031, 10035,},
    {10039, 10043, 10047, 10051, 10055, 10059, 10063, 10066, 10070, 10074,},
    {10078, 10082, 10086, 10090, 10094, 10098, 10102, 10105, 10109, 10113,},
    {10117, 10121, 10125, 10129, 10133, 10137, 10141, 10145, 10148, 10152,},
    {10156, 10160, 10164, 10168, 10172, 10176, 10180, 10184, 10187, 10191,},
    {10195, 10199, 10203, 10207, 10211, 10215, 10219, 10223, 10226, 10230,},
    {10234, 10238, 10242, 10246, 10250, 10254, 10258, 10262, 10265, 10269,},
    {10273, 10277, 10281, 10285, 10289, 10293, 10297, 10301, 10305, 10308,},
    {10312, 10316, 10320, 10324, 10328, 10332, 10336, 10340, 10343, 10347,},
    {10351, 10355, 10359, 10363, 10367, 10371, 10375, 10379, 10382, 10386,},
    {10390, 10394, 10398, 10402, 10406, 10410, 10414, 10418, 10421, 10425,},
    {10429, 10433, 10437, 10441, 10445, 10449, 10453, 10456, 10460, 10464,},
    {10468, 10472, 10476, 10480, 10484, 10488, 10492, 10495, 10499, 10503,},
    {10507, 10511, 10515, 10519, 10523, 10527, 10530, 10534, 10538, 10542,},
    {10546, 10550, 10554, 10558, 10562, 10565, 10569, 10573, 10577, 10581,},
    {10585, 10589, 10593, 10597, 10601, 10604, 10608, 10612, 10616, 10620,},
    {10624, 10628, 10632, 10636, 10639, 10643, 10647, 10651, 10655, 10659,},
    {10663, 10667, 10671, 10674, 10678, 10682, 10686, 10690, 10694, 10698,},
    {10702, 10706, 10709, 10713, 10717, 10721, 10725, 10729, 10733, 10737,},
    {10740, 10744, 10748, 10752, 10756, 10760, 10764, 10768, 10772, 10775,},
    {10779, 10783, 10787, 10791, 10795, 10799, 10803, 10807, 10810, 10814,},
    {10818, 10822, 10826, 10830, 10834, 10838, 10841, 10845, 10849, 10853,},
    {10857, 10861, 10865, 10869, 10873, 10876, 10880, 10884, 10888, 10892,},
    {10896, 10900, 10904, 10907, 10911, 10915, 10919, 10923, 10927, 10931,},
    {10935, 10939, 10942, 10946, 10950, 10954, 10958, 10962, 10966, 10970,},
    {10973, 10977, 10981, 10985, 10989, 10993, 10997, 11001, 11004, 11008,},
    {11012, 11016, 11020, 11024, 11028, 11032, 11036, 11039, 11043, 11047,},
    {11051, 11055, 11059, 11063, 11067, 11070, 11074, 11078, 11082, 11086,},
    {11090, 11094, 11098, 11101, 11105, 11109, 11113, 11117, 11121, 11125,},
    {11129, 11132, 11136, 11140, 11144, 11148, 11152, 11156, 11160, 11163,},
    {11167, 11171, 11175, 11179, 11183, 11187, 11191, 11194, 11198, 11202,},
    {11206, 11210, 11214, 11218, 11222, 11225, 11229, 11233, 11237, 11241,},
    {11245, 11249, 11252, 11256, 11260, 11264, 11268, 11272, 11276, 11280,},
    {11283, 11287, 11291, 11295, 11299, 11303, 11307, 11311, 11314, 11318,},
    {11322, 11326, 11330, 11334, 11338, 11341, 11345, 11349, 11353, 11357,},
    {11361, 11365, 11369, 11372, 11376, 11380, 11384, 11388, 11392, 11396,},
    {11400, 11403, 11407, 11411, 11415, 11419, 11423, 11427, 11430, 11434,},
    {11438, 11442, 11446, 11450, 11454, 11457, 11461, 11465, 11469, 11473,},
    {11477, 11481, 11485, 11488, 11492, 11496, 11500, 11504, 11508, 11512,},
    {11515, 11519, 11523, 11527, 11531, 11535, 11539, 11542, 11546, 11550,},
    {11554, 11558, 11562, 11566, 11570, 11573, 11577, 11581, 11585, 11589,},
    {11593, 11597, 11600, 11604, 11608, 11612, 11616, 11620, 11624, 11627,},
    {11631, 11635, 11639, 11643, 11647, 11651, 11654, 11658, 11662, 11666,},
    {11670, 11674, 11678, 11681, 11685, 11689, 11693, 11697, 11701, 11705,},
    {11708, 11712, 11716, 11720, 11724, 11728, 11732, 11735, 11739, 11743,},
    {11747, 11751, 11755, 11759, 11762, 11766, 11770, 11774, 11778, 11782,},
    {11786, 11789, 11793, 11797, 11801, 11805, 11809, 11813, 11816, 11820,},
    {11824, 11828, 11832, 11836, 11840, 11843, 11847, 11851, 11855, 11859,},
    {11863, 11867, 11870, 11874, 11878, 11882, 11886, 11890, 11893, 11897,},
    {11901, 11905, 11909, 11913, 11917, 11920, 11924, 11928, 11932, 11936,},
    {11940, 11944, 11947, 11951, 11955, 11959, 11963, 11967, 11971, 11974,},
    {11978, 11982, 11986, 11990, 11994, 11997, 12001, 12005, 12009, 12013,},
    {12017, 12021, 12024, 12028, 12032, 12036, 12040, 12044, 12047, 12051,},
    {12055, 12059, 12063, 12067, 12071, 12074, 12078, 12082, 12086, 12090,},
    {12094, 12097, 12101, 12105, 12109, 12113, 12117, 12121, 12124, 12128,},
    {12132, 12136, 12140, 12144, 12147, 12151, 12155, 12159, 12163, 12167,},
    {12171, 12174, 12178, 12182, 12186, 12190, 12194, 12197, 12201, 12205,},
    {12209, 12213, 12217, 12220, 12224, 12228, 12232, 12236, 12240, 12244,},
    {12247, 12251, 12255, 12259, 12263, 12267, 12270, 12274, 12278, 12282,},
    {12286, 12290, 12293, 12297, 12301, 12305, 12309, 12313, 12317, 12320,},
    {12324, 12328, 12332, 12336, 12340, 12343, 12347, 12351, 12355, 12359,},
    {12363, 12366, 12370, 12374, 12378, 12382, 12386, 12389, 12393, 12397,},
    {12401, 12405, 12409, 12412, 12416, 12420, 12424, 12428, 12432, 12435,},
    {12439, 12443, 12447, 12451, 12455, 12458, 12462, 12466, 12470, 12474,},
    {12478, 12481, 12485, 12489, 12493, 12497, 12501, 12504, 12508, 12512,},
    {12516, 12520, 12524, 12527, 12531, 12535, 12539, 12543, 12547, 12550,},
    {12554, 12558, 12562, 12566, 12570, 12573, 12577, 12581, 12585, 12589,},
    {12593, 12596, 12600, 12604, 12608, 12612, 12616, 12619, 12623, 12627,},
    {12631, 12635, 12639, 12642, 12646, 12650, 12654, 12658, 12662, 12665,},
    {12669, 12673, 12677, 12681, 12685, 12688, 12692, 12696, 12700, 12704,},
    {12708, 12711, 12715, 12719, 12723, 12727, 12730, 12734, 12738, 12742,},
    {12746, 12750, 12753, 12757, 12761, 12765, 12769, 12773, 12776, 12780,},
    {12784, 12788, 12792, 12796, 12799, 12803, 12807, 12811, 12815, 12818,},
    {12822, 12826, 12830, 12834, 12838, 12841, 12845, 12849, 12853, 12857,},
    {12861, 12864, 12868, 12872, 12876, 12880, 12883, 12887, 12891, 12895,},
    {12899, 12903, 12906, 12910, 12914, 12918, 12922, 12925, 12929, 12933,},
    {12937, 12941, 12945, 12948, 12952, 12956, 12960, 12964, 12968, 12971,},
    {12975, 12979, 12983, 12987, 12990, 12994, 12998, 13002, 13006, 13010,},
    {13013, 13017, 13021, 13025, 13029, 13032, 13036, 13040, 13044, 13048,},
    {13052, 13055, 13059, 13063, 13067, 13071, 13074, 13078, 13082, 13086,},
    {13090, 13093, 13097, 13101, 13105, 13109, 13113, 13116, 13120, 13124,},
    {13128, 13132, 13135, 13139, 13143, 13147, 13151, 13155, 13158, 13162,},
    {13166, 13170, 13174, 13177, 13181, 13185, 13189, 13193, 13196, 13200,},
    {13204, 13208, 13212, 13216, 13219, 13223, 13227, 13231, 13235, 13238,},
    {13242, 13246, 13250, 13254, 13257, 13261, 13265, 13269, 13273, 13277,},
    {13280, 13284, 13288, 13292, 13296, 13299, 13303, 13307, 13311, 13315,},
    {13318, 13322, 13326, 13330, 13334, 13337, 13341, 13345, 13349, 13353,},
    {13357, 13360, 13364, 13368, 13372, 13376, 13379, 13383, 13387, 13391,},
    {13395, 13398, 13402, 13406, 13410, 13414, 13417, 13421, 13425, 13429,},
    {13433, 13436, 13440, 13444, 13448, 13452, 13455, 13459, 13463, 13467,},
    {13471, 13474, 13478, 13482, 13486, 13490, 13494, 13497, 13501, 13505,},
    {13509, 13513, 13516, 13520, 13524, 13528, 13532, 13535, 13539, 13543,},
    {13547, 13551, 13554, 13558, 13562, 13566, 13570, 13573, 13577, 13581,},
    {13585, 13589, 13592, 13596, 13600, 13604, 13608, 13611, 13615, 13619,},
    {13623, 13627, 13630, 13634, 13638, 13642, 13646, 13649, 13653, 13657,},
    {13661, 13665, 13668, 13672, 13676, 13680, 13684, 13687, 13691, 13695,},
    {13699, 13703, 13706, 13710, 13714, 13718, 13722, 13725, 13729, 13733,},
    {13737, 13741, 13744, 13748, 13752, 13756, 13759, 13763, 13767, 13771,},
    {13775, 13778, 13782, 13786, 13790, 13794, 13797, 13801, 13805, 13809,},
    {13813, 13816, 13820, 13824, 13828, 13832, 13835, 13839, 13843, 13847,},
    {13851, 13854, 13858, 13862, 13866, 13870, 13873, 13877, 13881, 13885,},
    {13888, 13892, 13896, 13900, 13904, 13907, 13911, 13915, 13919, 13923,},
    {13926, 13930, 13934, 13938, 13942, 13945, 13949, 13953, 13957, 13960,},
    {13964, 13968, 13972, 13976, 13979, 13983, 13987, 13991, 13995, 13998,},
    {14002, 14006, 14010, 14014, 14017, 14021, 14025, 14029, 14032, 14036,},
    {14040, 14044, 14048, 14051, 14055, 14059, 14063, 14067, 14070, 14074,},
    {14078, 14082, 14085, 14089, 14093, 14097, 14101, 14104, 14108, 14112,},
    {14116, 14120, 14123, 14127, 14131, 14135, 14138, 14142, 14146, 14150,},
    {14154, 14157, 14161, 14165, 14169, 14173, 14176, 14180, 14184, 14188,},
    {14191, 14195, 14199, 14203, 14207, 14210, 14214, 14218, 14222, 14225,},
    {14229, 14233, 14237, 14241, 14244, 14248, 14252, 14256, 14259, 14263,},
    {14267, 14271, 14275, 14278, 14282, 14286, 14290, 14294, 14297, 14301,},
    {14305, 14309, 14312, 14316, 14320, 14324, 14328, 14331, 14335, 14339,},
    {14343, 14346, 14350, 14354, 14358, 14362, 14365, 14369, 14373, 14377,},
    {14380, 14384, 14388, 14392, 14396, 14399, 14403, 14407, 14411, 14414,},
    {14418, 14422, 14426, 14429, 14433, 14437, 14441, 14445, 14448, 14452,},
    {14456, 14460, 14463, 14467, 14471, 14475, 14479, 14482, 14486, 14490,},
    {14494, 14497, 14501, 14505, 14509, 14513, 14516, 14520, 14524, 14528,},
    {14531, 14535, 14539, 14543, 14546, 14550, 14554, 14558, 14562, 14565,},
    {14569, 14573, 14577, 14580, 14584, 14588, 14592, 14595, 14599, 14603,},
    {14607, 14611, 14614, 14618, 14622, 14626, 14629, 14633, 14637, 14641,},
    {14644, 14648, 14652, 14656, 14660, 14663, 14667, 14671, 14675, 14678,},
    {14682, 14686, 14690, 14693, 14697, 14701, 14705, 14709, 14712, 14716,},
    {14720, 14724, 14727, 14731, 14735, 14739, 14742, 14746, 14750, 14754,},
    {14758, 14761, 14765, 14769, 14773, 14776, 14780, 14784, 14788, 14791,},
    {14795, 14799, 14803, 14806, 14810, 14814, 14818, 14821, 14825, 14829,},
    {14833, 14837, 14840, 14844, 14848, 14852, 14855, 14859, 14863, 14867,},
    {14870, 14874, 14878, 14882, 14885, 14889, 14893, 14897, 14900, 14904,},
    {14908, 14912, 14916, 14919, 14923, 14927, 14931, 14934, 14938, 14942,},
    {14946, 14949, 14953, 14957, 14961, 14964, 14968, 14972, 14976, 14979,},
};

unsigned int TEMP_R_VALUE_PT1 = 0;
unsigned int TEMP_R_VALUE_PT2 = 0;
unsigned char Current_meter_status;

float TEMP_CAL(unsigned int value) {
    unsigned int closest_i = 0, closest_j = 0;
    unsigned int min_diff = ~0; // Initialize to maximum possible value

    if (value >= 14979) {
        return 130.0;
    }
    for (unsigned int i = 0; i < ARR_SIZE(MeterTemperature_Table); i++) {
        for (unsigned int j = 0; j < ARR_SIZE(MeterTemperature_Table[0]); j++) {
            unsigned int diff = (value > MeterTemperature_Table[i][j]) ? (value - MeterTemperature_Table[i][j]) : (MeterTemperature_Table[i][j] - value);
            if (diff < min_diff) {
                min_diff = diff;
                closest_i = i;
                closest_j = j;
            }
        }
    }
    return closest_i + closest_j * 0.1;
}

//return  satatus=00 测量正常
//return  satatus=01 GP21故障
//return  satatus=10 PT1000传感器故障
/*
    测量循环:
    每隔30秒进行一次温度测量:
    Send SO = 0x02 Start_Temp
    Check-loop INTN = 0?
    Send SO = 0xB4, Read SI = STAT
    STAT&0x1E00 > 0: -> Error routine
    Send SO = 0xB0,
    Read SI = RES_0

    Send SO = 0xB1,
    Read SI = RES_1

    Send SO = 0xB2,
    Read SI = RES_2

    Send SO = 0xB3,
    Read SI = RES_3

    Rhot/Rref  = RES_3/RES_2
    Rcold/Rref = RES_0/RES_1
    跳转到查询表查询对应的温度.
*/

unsigned char TEST_GP21_Temp(unsigned long int * Hot_value, unsigned long int * Col_value) {
    unsigned int gp21_status = 0;   // 芯片故障码
    uint8_t GP2_Res_Bit = 0;        // 公司故障码
    //检测GP21芯片状态
    GP21_NSS_L;
    GP21_Write_Reg16(0X0200, 8);
    GP21_NSS_H;
    for (unsigned int i = 0; i < 0x1500; i++) {
        if (GP21_INT_VALUE == 0)goto TEST_TEMP;
    }
    GP21_NSS_H;
    return (uint8_t)setDataBit(GP2_Res_Bit, 2, true);
TEST_TEMP:
    GP21_NSS_L;
    GP21_Write_Reg16(0XB400, 8);
    gp21_status = GP21_Read_Status();
    GP21_NSS_H;
    if ((gp21_status & 0x1E00) != 0) {
        if (readDataBit(gp21_status, 12) == true) {
            // Err_short
            return (uint8_t)setDataBit(GP2_Res_Bit, 1, true);
        }
        if ((readDataBit(gp21_status, 9) == true) || (readDataBit(gp21_status, 10) == true)) {
            // Err_OverCount  Err_TDC_OverCount
            return (uint8_t)setDataBit(GP2_Res_Bit, 2, true);
        }
        if (readDataBit(gp21_status, 11) == true) {
            // Err_open
            GP2_Res_Bit = (uint8_t)setDataBit(GP2_Res_Bit, 0, true);
        }
    }

    uint64_t FLOW_VALUE_PS0 = 0;
    uint64_t FLOW_VALUE_PS1 = 0;
    uint64_t FLOW_VALUE_PS2 = 0;
    uint64_t FLOW_VALUE_PS3 = 0;
    GP21_NSS_L;
    GP21_Write_Reg16(0XB000, 8);
    FLOW_VALUE_PS0 = GP21_Get_Data32();
    GP21_NSS_H;

    GP21_NSS_L;
    GP21_Write_Reg16(0XB100, 8);
    FLOW_VALUE_PS1 = GP21_Get_Data32();
    GP21_NSS_H;

    GP21_NSS_L;
    GP21_Write_Reg16(0XB200, 8);
    FLOW_VALUE_PS2 = GP21_Get_Data32();
    GP21_NSS_H;

    GP21_NSS_L;
    GP21_Write_Reg16(0XB300, 8);
    FLOW_VALUE_PS3 = GP21_Get_Data32();
    GP21_NSS_H;

    // Rhot/Rref  = RES_3/RES_2
    // Rcold/Rref = RES_0/RES_1
    if (Hot_value != NULL) {
        (*Hot_value) = (FLOW_VALUE_PS3 * 10000) / (FLOW_VALUE_PS2 == 0 ? 1 : FLOW_VALUE_PS2);
    }

    if (Col_value != NULL) {
        (*Col_value) = (FLOW_VALUE_PS0 * 10000) / (FLOW_VALUE_PS1 == 0 ? 1 : FLOW_VALUE_PS1);
    }
    /*****************************/
    return GP2_Res_Bit;
}
void quicksort(unsigned long int arr[], int low, int high) {
    if (low < high) {
        int pivot = arr[high];
        int i = low - 1;
        for (int j = low; j < high; j++) {
            if (arr[j] < pivot) {
                i++;
                unsigned int temp = arr[i];
                arr[i] = arr[j];
                arr[j] = temp;
            }
        }
        unsigned int temp = arr[i + 1];
        arr[i + 1] = arr[high];
        arr[high] = temp;

        int pi = i + 1;
        quicksort(arr, low, pi - 1);
        quicksort(arr, pi + 1, high);
    }
}

void Test_PT1000(float * PT1000_T1, float * PT1000_T2) {
    unsigned long int TEST_PT1000_T1_VALUE[6];
    unsigned long int TEST_PT1000_T2_VALUE[6];
    GP21_Goto_Realy();
    for (int i = 0; i < 6; i++) {
        Current_meter_status = TEST_GP21_Temp(&TEST_PT1000_T1_VALUE[i], &TEST_PT1000_T2_VALUE[i]);
        if (!((Current_meter_status == 0) || (Current_meter_status == 1))) {
            break;
        }
    }

    if ((Current_meter_status == 0) || (Current_meter_status == 1)) {
        // Test T1
        quicksort(TEST_PT1000_T1_VALUE, 0, 5);
        TEMP_R_VALUE_PT1 = (TEST_PT1000_T1_VALUE[1] + TEST_PT1000_T1_VALUE[2] + TEST_PT1000_T1_VALUE[3] + TEST_PT1000_T1_VALUE[4]) >> 2;
        if (TEMP_R_VALUE_PT1 != 0) {
            (*PT1000_T1) = TEMP_CAL(TEMP_R_VALUE_PT1);
            if (((*PT1000_T1) == 0) || ((*PT1000_T1) == 130)) {
                (*PT1000_T1) = 45.0;
                SetErrerCode(CODE_ERR_T1_SENSOR_FAULT_GP2, true);
            } else {
                SetErrerCode(CODE_ERR_T1_SENSOR_FAULT_GP2, false);
            }
        }
        // Test T2
        quicksort(TEST_PT1000_T2_VALUE, 0, 5);
        TEMP_R_VALUE_PT2 = (TEST_PT1000_T2_VALUE[1] + TEST_PT1000_T2_VALUE[2] + TEST_PT1000_T2_VALUE[3] + TEST_PT1000_T2_VALUE[4]) >> 2;
        if (TEMP_R_VALUE_PT2 != 0) {
            (*PT1000_T2) = TEMP_CAL(TEMP_R_VALUE_PT2);
            if (((*PT1000_T2) == 0) || ((*PT1000_T2) == 130)) {
                (*PT1000_T2) = 42.0;
                SetErrerCode(CODE_ERR_T2_SENSOR_FAULT_GP2, true);
            } else {
                SetErrerCode(CODE_ERR_T2_SENSOR_FAULT_GP2, false);
            }
        }
    } else {
        SetErrerCode(CODE_ERR_T1_SENSOR_FAULT_GP2, true);
        SetErrerCode(CODE_ERR_T2_SENSOR_FAULT_GP2, true);
    }
    //进入低功耗
    GP21_Goto_Low_Pwr();
}
